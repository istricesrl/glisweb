{% import '_bin/_default.html' as cms %}

{% extends 'ext/main.html' %}

{% block main %}
<section class="row flex-fill">
    <div class="col-md-8 d-flex flex-column">
        {% if session.carrello.id %}
        <form id="carrello" class="carrello d-flex flex-column flex-fill" action="" method="post">
            <input type="hidden" id="ts_checkout" name="__carrello__[timestamp_checkout]" value="">
            <input type="hidden" id="ck_carrello" name="ck_carrello" value="">

            <fieldset>
                <legend>dati carrello <small>#{{ session.carrello.id }}</small></legend>
                {# DATI DI INTESTAZIONE DEL CARRELLO #}
                <div class="form-row">
                    <div class="col">
                        <label class="label-top">zona</label>
                        <select class="form-control form-control-sm" id="id_zona" name="__carrello__[id_zona]" required>
                        {% for zona in etc.id_zona %}
                        <option value="{{ zona.id }}"{% if zona.id == session.carrello.id_zona %} selected{% endif %}>{{ zona.__label__ }}</option>
                        {% endfor %}
                        </select>
                    </div>
                    <div class="col">
                        <label class="label-top">listino</label>
                        <select class="form-control form-control-sm" id="id_listino" name="__carrello__[id_listino]" required>
                        {% for listino in etc.id_listino %}
                        <option value="{{ listino.id }}"{% if listino.id == session.carrello.id_listino %} selected{% endif %}>{{ listino.__label__ }}</option>
                        {% endfor %}
                        </select>
                    </div>
                </div>
        
            </fieldset>

            <fieldset>
                <legend>contenuto carrello</legend>
                {# ARTICOLI DEL CARRELLO #}

                <table class="table">

                    <thead>
                        <tr>
                            <th>codice</th>
                            <th>descrizione</th>
                            <th class="text-right">sc. %</th>
                            <th class="text-right">sc. €</th>
                            <th class="text-right">q.tà</th>
                            <th class="text-right">prezzo</th>
                            <th></th>
                        </tr>
                    </thead>

                    <tbody>
                        {% for articolo, dati in session.carrello.articoli  %}
                        <input type="hidden" name="__carrello__[__articoli__][{{ dati.id_articolo ~ dati.destinatario_id_anagrafica }}][id_articolo]" value="{{ dati.id_articolo }}">
                        <input type="hidden" name="__carrello__[__articoli__][{{ dati.id_articolo ~ dati.destinatario_id_anagrafica }}][destinatario_id_anagrafica]" value="{{ dati.destinatario_id_anagrafica }}">
                        <tr class="articolo">
                            <td><span class="id-articolo">{{ dati.id_articolo }}</span></td>
                            <td><span class="descrizione nowrap">{{ dati.descrizione }}</span><span class="dettagli">{{ dati.dettagli }}</span></td>
                            <td><input class="form-control form-control-sm text-right" type="text" id="scperc{{ dati.id_articolo ~ dati.destinatario_id_anagrafica }}" name="__carrello__[__articoli__][{{ dati.id_articolo ~ dati.destinatario_id_anagrafica }}][sconto_percentuale]" value="{{ '%0.2f'|format(dati.sconto_percentuale) }}"></td>
                            <td><input class="form-control form-control-sm text-right" type="text" id="scval{{ dati.id_articolo ~ dati.destinatario_id_anagrafica }}" name="__carrello__[__articoli__][{{ dati.id_articolo ~ dati.destinatario_id_anagrafica }}][sconto_valore]" value="{{ '%0.2f'|format(dati.sconto_valore) }}"></td>
                            <td><input class="form-control form-control-sm text-right quantita" type="text" id="qta{{ dati.id_articolo ~ dati.destinatario_id_anagrafica }}" name="__carrello__[__articoli__][{{ dati.id_articolo ~ dati.destinatario_id_anagrafica }}][quantita]" value="{{ '%0.0f'|format(dati.quantita) }}"></td>
                            <td class="text-right">{{ '%0.2f'|format(dati.prezzo_lordo_finale) }} {{ session.carrello.valuta_utf8 }}</td>
                            <td class="text-right"><input class="btn btn-secondary btn-sm" type="button" value="rimuovi" onclick="$(this).closest('.articolo').find('.quantita').val('');$('#carrello').attr('action','{{ page.url[ localization.language.ietf ] }}');$('#carrello').submit();"></td>
                        </tr>
                        {% endfor %}
                        <tr>
                            <td>coupon</td>
                            <td><input class="form-control form-control-sm text-right quantita" type="text" id="coupon" name="__carrello__[codice_coupon]" value="{{ session.carrello.codice_coupon }}"></td>
                            <td>{% if session.carrello.sconto_percentuale_coupon %}{{ '%0.2f'|format(session.carrello.sconto_percentuale_coupon) }}%{% else %}-{% endif %}</td>
                            <td>{% if session.carrello.sconto_valore_coupon %}{{ '%0.2f'|format(session.carrello.sconto_valore_coupon) }} {{ session.carrello.valuta_utf8 }}{% endif %}</td>
                            <td></td>
                            <td></td>
                            <td class="text-right">{% if session.carrello.codice_coupon %}<input class="btn btn-secondary btn-sm" type="button" value="rimuovi" onclick="$('#coupon').val('');$('#carrello').attr('action','{{ page.url[ localization.language.ietf ] }}');$('#carrello').submit();">{% endif %}</td>
                        </tr>
                    </tbody>

                    <tfoot>
                        <tr>
                            <td class="text-right" colspan="5">totale generale</td>
                            <td class="nowrap text-right">{{ '%0.2f'|format(session.carrello.prezzo_lordo_finale) }} {{ session.carrello.valuta_utf8 }}</td>
                            <td class="text-right"><input class="btn btn-secondary btn-sm" type="button" value="ricalcola" onclick="$('#carrello').attr('action','{{ page.url[ localization.language.ietf ] }}');$('#carrello').submit();"></td>
                        </tr>
                    </tfoot>

                </table>

<!--

                {# ARTICOLI DEL CARRELLO #}
                {% for articolo, dati in session.carrello.articoli  %}
                <div class="form-row articolo">
                    <input type="hidden" name="__carrello__[__articoli__][{{ dati.id_articolo ~ dati.destinatario_id_anagrafica }}][id_articolo]" value="{{ dati.id_articolo }}">
                    <input type="hidden" name="__carrello__[__articoli__][{{ dati.id_articolo ~ dati.destinatario_id_anagrafica }}][destinatario_id_anagrafica]" value="{{ dati.destinatario_id_anagrafica }}">
                    <div class="d-none d-md-block col-md-auto col-form-label"><span class="id-articolo">{{ dati.id_articolo }}</span></div>
                    <div class="col-12 col-md col-form-label"><span class="descrizione">{{ dati.descrizione }}</span><span class="dettagli">{{ dati.dettagli }}</span></div>
                    <div class="col-4 col-md-1"><label class="label-top">sc. %</label><input class="form-control form-control-sm text-right" type="text" id="scperc{{ dati.id_articolo ~ dati.destinatario_id_anagrafica }}" name="__carrello__[__articoli__][{{ dati.id_articolo ~ dati.destinatario_id_anagrafica }}][sconto_percentuale]" value="{{ '%0.2f'|format(dati.sconto_percentuale) }}"></div>
                    <div class="col-4 col-md-1"><label class="label-top">sc. €</label><input class="form-control form-control-sm text-right" type="text" id="scval{{ dati.id_articolo ~ dati.destinatario_id_anagrafica }}" name="__carrello__[__articoli__][{{ dati.id_articolo ~ dati.destinatario_id_anagrafica }}][sconto_valore]" value="{{ '%0.2f'|format(dati.sconto_valore) }}"></div>
                    <div class="col-4 col-md-1"><label class="label-top">q.tà</label><input class="form-control form-control-sm text-right quantita" type="text" id="qta{{ dati.id_articolo ~ dati.destinatario_id_anagrafica }}" name="__carrello__[__articoli__][{{ dati.id_articolo ~ dati.destinatario_id_anagrafica }}][quantita]" value="{{ '%0.0f'|format(dati.quantita) }}"></div>
                    <div class="col-4 col-md-1 col-form-label text-right">{{ '%0.2f'|format(dati.prezzo_lordo_finale) }} {{ session.carrello.valuta_utf8 }}</div>
                    <div class="col-4 col-md-1 text-center"><input class="btn btn-secondary btn-sm" type="button" value="rimuovi" onclick="$(this).closest('.articolo').find('.quantita').val('');$('#carrello').attr('action','{{ page.url[ localization.language.ietf ] }}');$('#carrello').submit();"></div>
                </div>
                {% endfor %}
            </fieldset>
            <fieldset>
                <legend>dettagli</legend>
                {# DATI DEL CARRELLO #}
                <div class="form-row">
                    <div class="col-12 col-md col-form-label">coupon</div>
                    <div class="col-4 col-md-2"><input class="form-control form-control-sm text-right quantita" type="text" id="coupon" name="__carrello__[codice_coupon]" value="{{ session.carrello.codice_coupon }}"></div>
                    <div class="col-4 col-md-1 col-form-label text-right">{% if session.carrello.sconto_percentuale_coupon %}{{ '%0.2f'|format(session.carrello.sconto_percentuale_coupon) }}%{% else %}-{% endif %}</div>
                    <div class="col-4 col-md-1 col-form-label text-right">{% if session.carrello.sconto_valore_coupon %}{{ '%0.2f'|format(session.carrello.sconto_valore_coupon) }} {{ session.carrello.valuta_utf8 }}{% endif %}</div>
                    <div class="col-4 col-md-1 text-center">{% if session.carrello.codice_coupon %}<input class="btn btn-secondary btn-sm" type="button" value="rimuovi" onclick="$('#coupon').val('');$('#carrello').attr('action','{{ page.url[ localization.language.ietf ] }}');$('#carrello').submit();">{% endif %}</div>
                </div>
            </fieldset>
            <fieldset>
                <legend>totali</legend>
                {# TOTALI DEL CARRELLO #}
                <div class="form-row">
                    <div class="col-4 col-md-10 col-form-label text-right">totale generale</div>
                    <div class="col-4 col-md-1 col-form-label text-right">{{ '%0.2f'|format(session.carrello.prezzo_lordo_finale) }} {{ session.carrello.valuta_utf8 }}</div>
                    <div class="col-4 col-md-1 text-center"><input class="btn btn-secondary btn-sm" type="button" value="ricalcola" onclick="$('#carrello').attr('action','{{ page.url[ localization.language.ietf ] }}');$('#carrello').submit();"></div>
                </div>

        -->


            </fieldset>
            <fieldset>
                <legend>dati cliente</legend>
                {# DATI DELL'INTESTATARIO E DEL DESTINATARIO #}
                <div class="form-row">
                    <div class="col-auto">
                        <label class="label-top">persona</label>
                        <select class="form-control form-control-sm" id="intestazione_id_tipologia_anagrafica" name="__carrello__[intestazione_id_tipologia_anagrafica]" required>
                        <option></option>
                        {% for tana in etc.id_tipologia_anagrafica %}
                        <option value="{{ tana.id }}"{% if tana.id == session.carrello.intestazione_id_tipologia_anagrafica %} selected{% endif %}>{{ tana.__label__ }}</option>
                        {% endfor %}
                        </select>
                    </div>
                    <div class="col">
                        <label class="label-top">nome</label>
                        <input class="form-control form-control-sm" id="intestazione_nome" type="text" name="__carrello__[intestazione_nome]" value="{{ session.carrello.intestazione_nome }}" required>
                    </div>
                    <div class="col">
                        <label class="label-top">cognome</label>
                        <input class="form-control form-control-sm" id="intestazione_cognome" type="text" name="__carrello__[intestazione_cognome]" value="{{ session.carrello.intestazione_cognome }}" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="col-6">
                        <label class="label-top">ragione sociale (solo aziende)</label>
                        <input class="form-control form-control-sm" id="intestazione_denominazione" type="text" name="__carrello__[intestazione_denominazione]" value="{{ session.carrello.intestazione_denominazione }}">
                    </div>
                    <div class="col-6 col-md-3">
                        <label class="label-top">codice SDI (solo aziende)</label>
                        <input class="form-control form-control-sm" id="intestazione_sdi" type="text" name="__carrello__[intestazione_sdi]" value="{{ session.carrello.intestazione_sdi }}">
                    </div>
                    <div class="col-6 col-md-3">
                        <label class="label-top">indirizzo PEC (solo aziende)</label>
                        <input class="form-control form-control-sm" id="intestazione_pec" type="text" name="__carrello__[intestazione_pec]" value="{{ session.carrello.intestazione_pec }}">
                    </div>
                </div>
                <div class="form-row">
                    <div class="col-6">
                        <label class="label-top">codice fiscale</label>
                        <input class="form-control form-control-sm" id="intestazione_codice_fiscale" type="text" name="__carrello__[intestazione_codice_fiscale]" value="{{ session.carrello.intestazione_codice_fiscale }}" required>
                    </div>
                    <div class="col-6">
                        <label class="label-top">partita IVA</label>
                        <input class="form-control form-control-sm" id="intestazione_partita_iva" type="text" name="__carrello__[intestazione_partita_iva]" value="{{ session.carrello.intestazione_partita_iva }}">
                    </div>
                </div>
                <div class="form-row">
                    <div class="col-9 col-md-5">
                        <label class="label-top">indirizzo</label>
                        <input class="form-control form-control-sm" id="intestazione_indirizzo" type="text" name="__carrello__[intestazione_indirizzo]" value="{{ session.carrello.intestazione_indirizzo }}" required>
                    </div>
                    <div class="col-3 col-md-1">
                        <label class="label-top">CAP</label>
                        <input class="form-control form-control-sm" id="intestazione_cap" type="text" name="__carrello__[intestazione_cap]" value="{{ session.carrello.intestazione_cap }}" required>
                    </div>
                    <div class="col-7 col-md-4">
                        <label class="label-top">città</label>
                        <input class="form-control form-control-sm" id="intestazione_citta" type="text" name="__carrello__[intestazione_citta]" value="{{ session.carrello.intestazione_citta }}" required>
                    </div>
                    <div class="col-5 col-md-2">
                        <label class="label-top">provincia</label>
                        <select class="form-control form-control-sm" id="intestazione_id_provincia" name="__carrello__[intestazione_id_provincia]" required>
                        <option></option>
                        {% for prov in etc.id_provincia %}
                        <option value="{{ prov.id }}"{% if prov.id == session.carrello.intestazione_id_provincia %} selected{% endif %}>{{ prov.__label__ }}</option>
                        {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="col-6">
                        <label class="label-top">telefono</label>
                        <input class="form-control form-control-sm" id="intestazione_telefono" type="tel" name="__carrello__[intestazione_telefono]" value="{{ session.carrello.intestazione_telefono }}" required>
                    </div>
                    <div class="col-6">
                        <label class="label-top">e-mail</label>
                        <input class="form-control form-control-sm" id="intestazione_mail" type="email" name="__carrello__[intestazione_mail]" value="{{ session.carrello.intestazione_mail }}" required>
                    </div>
                </div>
            </fieldset>
            <fieldset class="mt-auto">
                <legend>azioni</legend>
                {# TODO QUI METTERE I TASTI RICALCOLA E PAGA #}
                {# TODO SE È ATTIVO IL MODULO DOCUMENTI AGGIUNGERE I TASTI PER CREARE RICEVUTA, FATTURA O SCONTRINO #}
                {# TODO SE C'È UNA RICEVUTA, FATTURA O SCONTRINO AGGIUNGERE IL TASTO PER STAMPARLI #}
                <div class="form-row">
                    <div class="col">
                        <input class="btn btn-secondary btn-sm btn-block" type="button" value="vai al pagamento" onclick="$('#ts_checkout').val( Math.floor( Date.now() / 1000 ) );$('#carrello').attr('action','{{ pages['ecommerce.pagamento'].url[ localization.language.ietf ] }}?__pagamenti__[id_carrello]={{ session.carrello.id }}');$('#carrello').submit();">
                    </div>
                </div>
            </fieldset>
        </form>
        {% else %}
        <fieldset>
            <legend>apri un carrello o aggiungi un articolo per iniziare</legend>
            {# TODO QUI MOSTRARE I CARRELLI DA CATTURARE #}
            {# TODO QUI MOSTRARE IL CAMPO RICERCA PER I CARRELLI NON PAGATI #}
            <p>nessun carrello aperto</p>
        </fieldset>
        {% endif %}
    </div>
    <div class="col-md-4 d-flex flex-column">
        {# TODO SE È ATTIVO IL MODULO ISCRIZIONI... #}
        {% if '0630.iscrizioni' in mods.active.array %}
	    <fieldset>
            <legend>gestione iscrizioni</legend>
            <div class="form-group form-row">
                <div class="col-12 col-md">
                    <button onclick="window.open('{{ pages['iscrizioni.view'].url[ localization.language.ietf ] }}','_self');" class="btn btn-secondary btn-sm btn-block">vai alle iscrizioni</button>
                </div>
            </div>
            <div class="form-group form-row">
                <div class="col-12 col-md">
                    <button onclick="window.open('{{ pages['corsi.view'].url[ localization.language.ietf ] }}','_self');" class="btn btn-secondary btn-sm btn-block">vai ai corsi</button>
                </div>
            </div>
        </fieldset>
        {% endif %}
        {# ...FINE BLOCCO ISCRIZIONI #}
        <fieldset>
            <legend>gestione articoli</legend>
            {# TODO QUI FARE UN SELETTORE AGGIUNGI/RIMUOVI #}
            {# TODO QUI AGGIUNGERE CAMPO PER BIPPARE GLI ARTICOLI PER CODICE O MATRICOLA CON AUTOFOCUS (INPUT) #}
            {# TODO QUI BOX AGGIUNTA ARTICOLO PER CODICE O MATRICOLA (TENDINA INTELLIGENTE) #}
            <form action="{{ pages['ecommerce.ricerca'].path[ localization.language.ietf ] }}" method="post">
                <div class="form-group form-row">
                    <div class="col">
                        <input type="text" id="ricerca" class="form-control form-control-sm" name="__ricerca__" value="{{ request.__ricerca__ }}">
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-secondary btn-sm btn-sqr btn-block"><i class="fa fa-search"></i></button>
                    </div>
                </div>
            </form>
            <div class="form-group form-row">
                <div class="col-12 col-md">
                    <button onclick="window.open('{{ pages['articoli.view'].url[ localization.language.ietf ] }}','_self');" class="btn btn-secondary btn-sm btn-block">vai agli articoli</button>
                </div>
            </div>
        </fieldset>
        {% if frequenti %}
        <fieldset>
            <legend>articoli frequenti</legend>
            {# TODO QUI BOX ARTICOLI FREQUENTI #}
        </fieldset>
        {% endif %}
<!--
	    <fieldset>
            <legend>riga libera</legend>
            {# TODO QUI METTERE I CAMPI PER L'AGGIUNTA DI UNA RIGA SENZA ARTICOLO (OPPURE UN BOTTONE PER ANDARE AL FORM DI INSERIMENTO RIGHE?) #}
        </fieldset>
-->
    </div>
</section>
{% endblock %}

{% block javascript %}
<script async defer type="text/javascript">
	window.addEventListener( 'DOMContentLoaded', function() {
        document.getElementById('ricerca').focus();
    });	
</script>
{% endblock %}
