{% import '_bin/_form.html' as frm %}
{% import 'bin/default.html' as def %}

{% extends "ext/main.html" %}

{% block main %}

{# DEFINIZIONI #}
{% set table = form.table %}
{% set ietf = localization.language.ietf %}

{# ACCOUNT #}
{% if session.account.id %}
    {% set account = session.account.id %}
{% else %}
    {% set account = '__null__' %}
{% endif %}

{# TIPO DI METODO E ATTIVITA' SVOLTA #}
{% if request[ table ].id %}
    {% set method = 'update' %}
    {% set activity = 'aggiornamento' %}
    {% set legend = 'aggiornato ' ~ request[ table ][ 'timestamp_aggiornamento' ]|date('Y/m/d H:i:s') %}
{% else %}
    {% set method = 'post' %}
    {% set activity = 'inserimento' %}
    {% set legend = 'inserimento nuovo oggetto' %}
{% endif %}

{# FORM DI GESTIONE #}

<section class="row">
    <div class="col-md-12">
	<form id="form-{{ table }}" class="" action="{{ page.path[ localization.language.ietf ] }}" method="post">

	    {# CAMPI HIDDEN DI BASE #}

	    <input type="hidden" id="table" name="{{ table }}[id]" value="{{ request[ table ].id }}">
	    <input type="hidden" id="method" name="{{ table }}[__method__]" value="{{ method }}">
	    <input type="hidden" id="reset" name="{{ table }}[__reset__]" value="1">
	    <input type="hidden" id="timestamp" name="{{ table }}[timestamp_{{ activity }}]" value="{{ 'now'|date('U') }}">
	    <input type="hidden" id="account" name="{{ table }}[id_account_{{ activity }}]" value="{% if session.account.id %}{{ session.account.id }}{% else %}__null__{% endif %}">
	    <input type="hidden" id="job" name="{{ table }}[job]" value="{{ etc.jobfile }}">
		<input type="hidden" id="backurl" name="__backurl__" value="{{ request.__backurl__ }}">

	    {# NOTE DI IMPORTAZIONE #}

	    <fieldset class="import-schema">
		<legend>note di importazione</legend>

		<div class="form-group form-row">
		    <div class="col-12">
			<p>Il file di importazione dev'essere in formato Excel 2007/2010 (Excel Workbook) con estensione .xlsx e deve
			rispettare lo schema sotto riportato. La prima riga deve contenere i nomi dei campi, il cui ordine non è vincolante
			in quanto il sottoprogramma di importazione assegna i dati ai campi in base all'intestazione di colonna e non
			all'ordine delle colonne stesse; è imperativo che i nomi delle colonne siano gli stessi dei campi, ma non sono case sensitive.
			Se non diversamente specificato, anche i valori inseriti non sono case sensitive. Un file XLSX di esempio è disponibile per il download a
			<a href="{{ site.root }}_usr/_examples/_import/importazione.prodotti.xlsx">questo indirizzo</a>.
		    </div>
		</div>

		<div class="form-group form-row">
		    <div class="col-12 table-responsive">
			<table class="table">
			    <thead>
				<tr>
				    <th class="text-center">campo</th>
				    <th class="text-center">tipo di dato</th>
				    <th class="text-center">valori ammessi</th>
				    <th class="text-center">opzionale</th>
				    <th class="text-left">note</th>
				</tr>
			    </thead>
			    <tbody>
				<tr>
				    <th class="text-right">prodotto</th>
				    <td class="text-center">stringa</td>
				    <td class="text-center">qualsiasi</td>
				    <td class="text-center">no</td>
				    <td class="text-left">il codice identificativo del prodotto</td>
				</tr>
				<tr>
				    <th class="text-right">nome</th>
				    <td class="text-center">stringa</td>
				    <td class="text-center">qualsiasi</td>
				    <td class="text-center">no</td>
				    <td class="text-left">caratteristica del prodotto</td>
				</tr>
		
			  </tbody>
		        </table>
		    </div>
		</div>

	    </fieldset>


	    {# JOB IN CORSO #}

	    {% if etc.jobs %}
	    <fieldset>
		<legend>job in corso</legend>

		<div class="form-group form-row">
		    <div class="col-12 table-responsive">

			<table class="view-table">
			    <thead>
				<tr>
				    <th class="text-center">inizio</th>
				    <th class="text-center">elaborazione</th>
				    <th class="text-center">avanzamento</th>
				    <th class="text-left">nome</th>
				    <th class="text-left">status</th>
				</tr>
			    </thead>
			    <tbody>
				{% for job in etc.jobs %}
				<tr>
				    <td class="text-center">{{ job.timestamp_apertura|date('Y-m-d H:i') }}</td>
				    <td class="text-center">{{ job.timestamp_esecuzione|date('Y-m-d H:i') }}</td>
				    <td class="text-center">{% if job.corrente %}{{ job.corrente }} di {{ job.totale }}{% else %}non iniziato{% endif %}</td>
				    <td class="text-left">{{ job.nome }}</td>
				    <td class="text-left">{{ job.workspace.status }}</td>
				</tr>
				{% endfor %}
			    </tbody>
			</table>

		    </div>
		</div>

	    </fieldset>
	    {% endif %}

	    {# MODULO PRINCIPALE #}

	    <fieldset>
		<legend>avvio del job di importazione</legend>

		<div class="form-group form-row">
		    <div class="col-12 col-md-auto">
			{{ frm.datetimeRequired( table, '', '', 'timestamp_apertura', 'data e ora di inizio', '', request, 'now'|date('Y-m-d\\TH:i') ) }}
		    </div>
		    <div class="col-10 col-md">
			{{ frm.inputRequired( table, '', '', 'nome', 'nome del job', '', request ) }}
		    </div>
		    <div class="col-2 col-md-1">
			{{ frm.inputRequired( table, '', '', 'iterazioni', 'passo', '1', request ) }}
		    </div>
		    <div class="col-12 col-md">
			{{ frm.uploader( '__' ~ table ~ '__', '', '', 'document', '', '', request, '', site ) }}
		    </div>
		</div>

	    </fieldset>

	    {# BOTTONI E COMANDI DEL MODULO #}

	    <fieldset class="form-controls mt-auto">
			{{ def.controls( page, pages, ietf, session, table, request ) }}
		</fieldset>
	

	</form>
    </div>
</section>

{% endblock %}
