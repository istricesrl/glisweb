/*!

    \page moduli_ecommerce modulo e-commerce del framework

    Panoramica del modulo e-commerce del framework.

    introduzione
    ============



    tabelle
    -------



    gestione dei dati in ingresso
    -----------------------------
    Come già visto per il modulo contatti, anche il modulo e-commerce dovendo gestire dati provenienti dal front-end ha una propria controller
    specializzata. Questa controller, implementata nel file _mod/_4170.ecommerce/_src/_config/_750.controller.php, viene attivata dalla chiave
    __carrello__ e si occupa di gestire sia la testata che le righe del carrello.

    il flusso di acquisto
    =====================
    Il caso più comune di flusso di acquisto è quello che prevede l'aggiunta di prodotti al carrello, la conferma dei dati, la chiusura del carrello;
    tale chiusura può avvenire in diversi modi secondo la modalità di pagamento selezionata, e principalmente i casi qui sono due ovvero la chiusura
    diretta, utilizzata per modalità quali il contrassegno e il bonifico, e quella tramite provider di pagamento esterno, usata per PayPal, carte di
    credito, e simili. Esistono e-commerce semplificati in cui vari passaggi sono riassunti in uno solo ma in tutti i casi è al minimo presente una
    pagina per l'inserimento dei dati e una pagina di riepilogo che prepara la chiusura dell'ordine.

    Fra gli esempi del framework è presente una struttura elementare che riproduce questo schema, costituita dai file:

    - _usr/_examples/_ecommerce/_acquisto.01.php che simula una pagina prodotto tramite la quale è possibile aggiungere un prodotto al carrello
    - _usr/_examples/_ecommerce/_acquisto.02.php che simula la pagina di inserimento dati del carrello
    - _usr/_examples/_ecommerce/_acquisto.03.php che simula la pagina di riepilogo del carrello che prepara la chiusura dell'ordine
    - _usr/_examples/_ecommerce/_esito.php che simula la pagina di esito generico del pagamento, che deve capire se c'è stato un successo o un fallimento
    - _usr/_examples/_ecommerce/_esito.ck.php che simula la pagina di chiusura diretta del carrello
    - _usr/_examples/_ecommerce/_esito.php che simula la pagina di esito generico del pagamento

    le pagine di prodotto
    ---------------------

    [...] lo step 01 del processo di acquisto.

    la pagina di inserimento dati del carrello
    ------------------------------------------

    [...] lo step 02 del processo di acquisto.

    [...] fra le altre cose, deve inviare allo step 03 la modalità da utilizzare per il pagamento tramite il campo __carrello__[provider_pagamento]. Il valore
    di questo campo dev'essere una delle chiavi dell'array $cf['ecommerce']['profiles'][<STATUS>]['provider']. La selezione del provider di acquisto può essere
    fatta ad esempio con una tendina:

    \code{.html}
    <select id="carrelloProviderPagamento" name="__carrello__[provider_pagamento]">
      {% for provider,details in ecommerce.profile.provider %}
        <option value="{{ provider }}">{{ details.__label__ }}</option>
      {% endfor %}
    \endcode

    Oppure con dei pulsanti:

    \code{.html}
    <input type="hidden" id="carrelloProviderPagamento" name="__carrello__[provider_pagamento]" value="">
    <script>
      function setProviderCheckAndSubmit( provider ) {
        var carrelloForm = document.getElementById('{{ form }}');
        document.getElementById('carrelloProviderPagamento').value = provider;
		if( carrelloForm.checkValidity() ) {
			carrelloForm.submit();
		} else {
            carrelloForm.reportValidity();
        } 
      }
    </script>
    {% for provider,details in ecommerce.profile.provider %}
    <button type="button" onclick="setProviderCheckAndSubmit('{{ provider }}');">{{ details.__label__ }}</button>
    {% endfor %}
    \endcode

    la pagina di riepilogo del carrello
    -----------------------------------

    [...] _mod/_4170.ecommerce/_src/_inc/_macro/_carrello.riepilogo.php

    [...] lo step 03 del processo di acquisto.

    [...] volendo saltare la pagina di riepilogo è possibile inserire un submit() del form all'onload della pagina direttamente nello schema Twig.

    la pagina di esito generico di pagamento
    ----------------------------------------

    [...] macro _mod/_4170.ecommerce/_src/_inc/_macro/_carrello.esito.php

    [...] visualizza un contenuto diverso secondo se rileva un successo o un fallimento nel pagamento
    [...] imposta la timestamp_checkout solo in caso di esito positivo (è comunque reimpostata dal listener)
    [...] non chiama le macro di successo (vengono chiamate dal listener)
    [...] scrive sul log del carrello

    la pagina di chiusura diretta del carrello
    ------------------------------------------

    [...] macro _mod/_4170.ecommerce/_src/_inc/_macro/_carrello.checkout.php

    [...] imposta la timestamp_checkout
    [...] chiama le macro di successo
    [...] scrive sul log del carrello

    il carrello
    ===========

    struttura del carrello
    ----------------------

    calcolo del costo totale degli articoli
    ---------------------------------------

    [...] l'aliquota IVA applicata agli articoli dipende in prima istanza dall'aliquota IVA associata agli articoli stessi, e in subordine
    all'aliquota applicabile all'utente (ad es. utenti che beneficiano di esenzioni specifiche) oppure dal paese di spedizione degli articoli
    acquistati (ad es. spedizione all'estero).

    [...] il listino utilizzato per il calcolo dei prezzi è quello impostato nel carrello, e può dipendere dall'utente collegato, dal paese di
    destinazione degli articoli acquistati, e da altri fattori custom.

    [...] eventuali variazioni di prezzo applicabili agli articoli acquistati sono considerate dalla funzione calcolaPrezzoNettoArticolo() e di
    conseguenza anche dalla funzione calcolaPrezzoLordoArticolo() che utilizza a sua volta la calcolaPrezzoNettoArticolo().

    calcolo dei coupon
    ------------------

    calcolo dei costi di spedizione
    -------------------------------

    il checkout
    ===========
    Il checkout è propriamente la chiusura dell'ordine, che può essere contestuale al pagamento, ad esempio nei pagamenti online tramite
    Nexi, PayPal o simili, oppure precedente, nel caso si utilizzino sistemi di pagamento offline quali contrassegno, bonifico bancario o simili;
    in quest'ultimo caso, il pagamento andrà registrato manualmente una volta che sia effettivamente avvenuto.

    Il ruolo del checkout è quello di concludere le operazioni di ordine e liberare la sessione per l'apertura di un nuovo carrello; questo avviene
    nel file _src/_config/_710.session.php del modulo e-commerce. Una volta che la timestamp_checkout è stata valorizzata, l'ordine si considera
    inviato ed è possibile procedere con un nuovo ordine.

    Nel caso di pagamenti online quali PayPal, Nexi, eccetera, la timestamp_checkout è valorizzata nei rispettivi listener collocati nella cartella
    _src/_api/ del modulo e-commerce e, per maggiore sicurezza, nelle macro di pagina _src/_inc/_macro/_carrello.esito.php;
    nel caso invece dei pagamenti offline, la valorizzazione della timestamp_checkout è effettuata nella macro di pagina _src/_inc/_macro/_carrello.checkout.php.
    Il motivo per cui nel caso dei pagamenti online la timestamp_checkout viene valorizzata nella macro di pagina oltre che nel listener è che può verificarsi
    un'apprezzabile latenza fra la chiusura dell'ordine, con relativo ritorno dell'utente al sito, e la chiamata in background al listener da parte del provider
    di pagamento. Per evitare che in questa finestra di tempo l'utente possa volontariamente o accidentalmente modificare il carrello, la timestamp_checkout
    viene valorizzata non appena l'utente stesso ritorna al sito, così da minimizzare il rischio di manomissioni o errori.

    il processo di pagamento
    ========================

    pagamento in contrassegno
    -------------------------

    pagamento tramite bonifico bancario
    -----------------------------------

    pagamento tramite PayPal Payments Standard
    ------------------------------------------
    Il pagamento tramite PayPal (tecnicamente PayPal Payments Standard tramite HTML form) avviene inviando un pacchetto dati POST all'endpoint PayPal
    predisposto alla gestione dei pagamenti, che si occuperà di interagire con l'utente per finalizzare la transazione. Una volta concluso con successo
    il pagamento, PayPal rimanderà l'utente sulla pagina del sito specificata fra i parametri del form, e in background effettuerà una chiamata all'API
    del sito predisposta per la gestione delle informazioni di conferma di PayPal (_src/_api/_paypal.listener.php), il cui compito è resistrare sul
    carrello l'avvenuto pagamento; per ulteriori dettagli si rimanda ai commenti al codice dell'API stessa.

    Il lavoro del framework relativamente a questa forma di pagamento si riassume quindi nella compilazione del form con i dati corretti (compito svolto
    dalla pagina di riepilogo del carrello), al suo invio a PayPal, e alla gestione delle informazioni di ritorno tramite l'API vista sopra.

    pagamento tramite PayPal Advanced Checkout
    ------------------------------------------
    Il pagamento tramite PayPal Advanced Checkout avviene tramite alcuni passaggi, più complessi rispetto a quanto visto per PayPal Payments Standard;
    vengono effettuati diversi scambi dati fra il sito e PayPal durante il flusso di pagamento, ed è importante comprenderli per poter gestire correttamente
    l'integrazione. Innanzitutto ci si sinceri di aver correttamente inserito i dati per la connessione a PayPal nel file src/config.json:

    \code{.json}
    "ecommerce": {
      "profiles": {
        "DEV": {
          "provider": {
          "paypal-advanced": {
            "advanced": true,
            "business": "BUSINESS_ID",
            "client_id": "CLIENT_ID",
            "client_secret": "CLIENT_SECRET"
            }
          }
        }
      }
    }
    \endcode

    Per procurarsi i dati necessari occorre creare un account sviluppatore su PayPal (vedi https://developer.paypal.com/dashboard/). Per abilitare i pagamenti
    avanzati, sempre dalla dashboard sviluppatore selezionare il nome dell'app che si intende usare per il sito, andare su "Features > Accept payments"
    dopodiché spuntare "Advanced Credit and Debit Card Payments" e salvare le modifiche.

    L'integrazione con PayPal Advanced Checkout avviene da un punto di vista pratico tutta a livello di step 03 (riepilogo), in quanto la macro di questa pagina
    in combinazione con il codice HTML e JavaScript del front-end svolgono tutte le attività necessarie.

    [...] il form seguente in base alla presenza del token di connessione a PayPal o meno:

    \code{.html}
    {% if etc.client_token %}
    <!-- PAGAMENTO TRAMITE PAYPAL STANDARD O ADVANCED CHECKOUT -->

    <!-- variabile per l'URL di ritorno -->
    {% if ecommerce.profile.provider['paypal-advanced'].return_url %}
    <script> var return_url = "{{ ecommerce.profile.provider['paypal-advanced'].return_url }}";</script>
    {% endif %}

    <!-- inclusione dello script di PayPal -->
    <script src="https://www.paypal.com/sdk/js?components=buttons,hosted-fields&amp;currency=EUR&amp;disable-funding=sofort,mybank&amp;client-id={{ ecommerce.profile.provider['paypal-advanced'].client_id }}" data-client-token="{{ etc.client_token }}"></script>

    <!-- div per la creazione del bottone PayPal Standard Checkout e Advanced Checkout --> 
    <div id="paypal-button-container" class="paypal-button-container"></div>

    <!-- form per il pagamento tramite PayPal Advanced Checkout -->
    {% if ecommerce.profile.provider['paypal-advanced'].advanced %}
    <style>
      div.card_field {
        height: 1em;
        margin-bottom: .5em;
      }
    </style>
    <div class="card_container">
        <form id="card-form">
            <label for="card-number">Card Number</label>
            <div id="card-number" class="card_field"></div>
        <div>
            <label for="expiration-date">Expiration Date</label>
            <div id="expiration-date" class="card_field"></div>
        </div>
        <div>
            <label for="cvv">CVV</label>
            <div id="cvv" class="card_field"></div>
        </div>
        <div>
            <label for="card-holder-name">Name on Card</label>
            <input type="text" id="card-holder-name" name="card-holder-name" autocomplete="off" placeholder="card holder name"/>
        </div>
        <div>
            <label for="card-billing-address-street">Billing Address</label>
            <input type="text" id="card-billing-address-street" name="card-billing-address-street" autocomplete="off" placeholder="street address"/>
        </div>
        <div>
            <label for="card-billing-address-unit">&nbsp;</label>
            <input type="text" id="card-billing-address-unit" name="card-billing-address-unit" autocomplete="off" placeholder="unit"/>
        </div>
        <div>
            <label for="card-billing-address-city">&nbsp;</label>
            <input type="text" id="card-billing-address-city" name="card-billing-address-city" autocomplete="off" placeholder="city"/>
        </div>
        <div>
            <label for="card-billing-address-state">&nbsp;</label>
            <input type="text" id="card-billing-address-state" name="card-billing-address-state" autocomplete="off" placeholder="state"/>
        </div>
        <div>
            <label for="card-billing-address-zip">&nbsp;</label>
            <input type="text" id="card-billing-address-zip" name="card-billing-address-zip" autocomplete="off" placeholder="zip / postal code"/>
        </div>
        <div>
            <label for="card-billing-address-country">&nbsp;</label>
            <input type="text" id="card-billing-address-country" name="card-billing-address-country" autocomplete="off" placeholder="country code" />
        </div>
        <button value="submit" id="submit" class="btn">Pay</button>
        </form>
    </div>
    {% endif %}

    {% elseif etc.meta.action and etc.meta.method %}
    <!-- PAGAMENTO TRAMITE PAYPAL PAYMENTS STANDARD, NEXI, E SIMILI -->

    <!-- form per il pagamento -->
    <form action="{{ etc.meta.action }}" method="{{ etc.meta.method }}">
      {% for field, value in etc.fields %}
      <input type="hidden" name="{{ field }}" value="{{ value }}" />
      {% endfor %}
      <button type="submit">PAGA</button>
    </form>

    {% endif %}
    \endcode

    [...] le attività del back-end della pagina di riepilogo sono:

    - la creazione del token di connessione a PayPal [...]

    pagamento tramite Nexi
    ----------------------

    [...] vedi https://ecommerce.nexi.it/sviluppatori

    [...] Nexi si comporta come PayPal per esito e annullamento (vedi https://ecommerce.nexi.it/specifiche-tecniche/codicebase.html)

    pagamento tramite Soisy
    -----------------------

    [...] vedi https://www.soisy.it/integrazione/api-ordine-crea/

    pagamento tramite Satispay
    --------------------------

    [...] vedi anche https://developers.satispay.com/docs/welcome

    note sull'implementazione di nuove forme di pagamento
    -----------------------------------------------------

    correlazioni fra il modulo e-commerce e gli altri moduli
    ========================================================


    correlazione con il modulo 0530.crediti
    ---------------------------------------


    correlazione con il modulo 3500.risorse
    ---------------------------------------

    [...] affinché un articolo metta una data risorsa in disponibilità dell'account che effettua l'acquisto, è necessario specificare i metadati:
    - risorse|acquisto per indicare l'ID della risorsa da mettere disponibile all'account che ha effettuato l'acquisto
    - se_login per indicare che è necessario aver effettuato il login per completare l'acquisto (diversamente non sarebbe possibile associare la risorsa)

    correlazione con il modulo 0920.corsi
    -------------------------------------

    [...] 

    correlazione con il modulo 0400.documenti
    -----------------------------------------

    [...] affinché un articolo incrementi il numero di crediti SAAS dell'account che effettua l'acquisto, è necessario specificare i metadati:
    - crediti|incremento per indicare il numero di crediti da incrementare
    - crediti|mastro per indicare l'ID del mastro su cui incrementare i crediti
    - se_login per indicare che è necessario aver effettuato il login per completare l'acquisto (diversamente non sarebbe possibile attribuire i crediti)

    personalizzazione dell'aspetto dell'e-commerce
    ==============================================

    note sul template Lydia
    -----------------------

    personalizzazione delle pagine del carrello specifica per sito
    --------------------------------------------------------------

    \code{.json}
    "sites": {
      "1": {
        [...]
        "contents": {
          "pages": {
            "carrello_successo": {
              "template": "path/per/il/template/",
              "schema": "schema.custom.html",
              "theme": "tema.custom.css"
            },
            [...]
          }
        },
        [...]
      }
    }
    \endcode

    tracciatura delle conversioni
    =============================

    [...] https://developers.google.com/analytics/devguides/collection/protocol/v1/parameters#ecomm
    [...] https://developers.google.com/analytics/devguides/collection/protocol/ga4/reference/events#purchase

    domande frequenti
    =================

    In questa sezione sono state radunate le domande poste più di frequente sul modulo e-commerce.

    come posso emettere automaticamente una fattura quando un carrello viene pagato?
    --------------------------------------------------------------------------------

    [...] creare una controller custom in mod/0400.documenti/src/inc/controllers/checkout.finally.success.php e inserire lì le logiche necessarie alla creazione
    e all'invio della fattura.

*/
